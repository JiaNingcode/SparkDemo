**1.数仓建模方法论**

1.1 三范式
1.1.1 函数依赖
（1）完全函数依赖
（2）部分函数依赖
（3）传递函数依赖

1.1.2
（1）第一范式：原子性 , 属性不可分割
（2）第二范式：唯一性约束(有主键id), 不能存在非主键字段部分函数依赖主键字段
（3）第三范式：不能存在非主键字段传递函数依赖主键字段,消除字段冗余 字段不能由其他字段派生出来，字段没有冗余


**2. 数仓分层**
2.1 ODS层（原始数据层）
（1）ODS表结构设计依赖于业务同步的数据结构，存储原始数据表
（2）ODS保存全部历史数据，要使用压缩比高的gzip
（3）ODS命名规范：ods_tableName_单分区全量/增量标识（inc/full）

2.2 DIM层（数据维度层）
（1）DIM层的设计依据是维度建模理论，存储的是维度表
（2）DIM层的数据存储格式为orc列式存储+snappy压缩
（3）DIM层表名的命名规范：dim_tableName_全量表或拉链表标识（full/zip）

2.3 DWD层（数据明细层）
（1）DWD设计依据是维度建模理论，存储的是事实表
（2）DWD层的数据存储格式为orc列式存储+snappy压缩
（3）DWD层表名的命名规范：dwd_数据域_tableName_单分区全量/增量标识（inc/full）

2.4 DWS层（数据汇总层）
（1）DWS层设计参考指标体系，存储公共粒度汇总表
（2）DWS层的数据存储格式为orc列式存储+snappy压缩
（3）DWS层命名规范：dws_数据域_统计粒度_业务过程_统计周期（1d/nd/td）

2.5 ADS层（数据应用层）


**3.维度建模理论**
3.1 事实表
3.1.1 概述
    数仓维度建模核心，围绕业务过程设计，字段包含业务过程有关的维度外键，通常是可以累加的数字字段类型。

3.1.2 特点
    细长（列少，行多），行的增速快

3.1.3 事实表分类
    （1）事务事实表
    （2）周期快照事实表：存量型指标
    （3）累积快照事实表：多事务关联统计
    
3.1.4 事实表设计流程
选择业务过程:业务过程为一个个不可拆分的行为事件
    ｜
声明粒度：选择最细粒度
    ｜
确认维度：确定每张事实表的相关维度
    ｜
确认事实：确定业务过程的度量值（次数，个数，金额等

3.1.5 事实类型
（1）可加事实：可以按照与事实表相关的所有维度进行累加
（2）半可加事实：只能按照事实表部分维度进行累加（不能按照时间维度累加）
（3）不可加事实：不具备可加性，如比率型事实


3.2 维度表
3.2.1 概述
    维度表围绕业务过程所处环境进行设计，主要包含主键和各种维度字段（维度属性）

3.2.2 维度表设计流程
（1）确定维度表：事实表相关维度，理论上每个维度需要对应一张维度表。
注：维度退化：多张事实表可能依赖同一张维度表，这张维度表具有唯一性。如果这张维度表的维度属性特别少，可以不创建，将属性退化到事实表中。
（2）确定主维表和相关维表：主维表主要和事实表关联，相关维表和主维表相关联。
（3）确认维度属性：维度属性可直接从主维表或相关维表中选择，也可通过进一步拆分得到。
注：尽可能生成丰富得维度属性；尽量不适用编码，一般使用文字和编码共存；尽量沉淀初通用的维度属性。

3.2.3 维度设计要点
（1）规范化（雪花模型）：粗粒度到细粒度，减少数据冗余，一张表的字段拆到多张表
（2）反规范化（星型模型）：细粒度到粗粒度，减少join，提高查询性能

3.2.4 维度变化
    维度属性不是不变的，如用户手机号，蔬菜价格等。保存维度历史状态通常有两种办法
    （1）全量快照表（经常变化的维度）：优点简单高效，缺点浪费存储空间
    
    （2）拉链表（缓慢变化维度）：有点节省存储空间，缺点操作复杂
    
3.2.5 拉链表
    记录每条信息的生命周期，一条纪录生命周期结束，重新记录新的记录，并把当前日期放入开始生效日期。如果当前记录至今有效，在截止日期加上一个极大值（9999-12-31）

拉链表设计：首日装载同步当日全量表装载到拉链表中
            每日装载获取当前前一日的全量最新 full join 当日新增和变化的然后再union all过期状态的再动态分区装载到拉链表中

